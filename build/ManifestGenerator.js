// Generated by CoffeeScript 1.9.3
(function() {
  var ManifestGenerator, cfs, constants, fs, log, path;

  cfs = require('./cfs');

  constants = require('./constants');

  fs = require('fs');

  log = require('./log');

  path = require('path');

  ManifestGenerator = (function() {
    function ManifestGenerator(rootDir) {
      this.rootDir = rootDir;
    }

    ManifestGenerator.prototype.generate = function() {
      var atLeaf, children, clientManifest, comic, comics, dir, exists, flat, i, indexDir, indexMetadata, indexlist, issues, j, k, keys, len, len1, list, metadata, newchildren, parsed, ref, serverManifest;
      comics = cfs.gatherComics(this.rootDir);
      children = {};
      issues = {};
      exists = {};
      flat = [];
      for (i = 0, len = comics.length; i < len; i++) {
        comic = comics[i];
        metadata = cfs.readMetadata(comic.dir);
        parsed = path.parse(comic.relativeDir);
        indexDir = parsed.dir;
        flat.push({
          dir: comic.relativeDir,
          pages: metadata.pages
        });
        dir = comic.relativeDir;
        atLeaf = true;
        while (true) {
          parsed = path.parse(dir);
          indexDir = (ref = parsed.dir) != null ? ref : "";
          if (!children.hasOwnProperty(indexDir)) {
            children[indexDir] = {};
          }
          if (atLeaf) {
            children[indexDir][comic.relativeDir] = {
              type: 'comic',
              dir: comic.relativeDir,
              pages: metadata.pages,
              timestamp: comic.timestamp
            };
            exists[comic.relativeDir] = true;
          } else {
            indexMetadata = cfs.readMetadata(path.join(this.rootDir, dir));
            children[indexDir][dir] = {
              type: 'index',
              dir: dir,
              recent: indexMetadata.recent,
              count: indexMetadata.count,
              timestamp: indexMetadata.timestamp,
              first: indexMetadata.first
            };
          }
          atLeaf = false;
          if (!issues.hasOwnProperty(indexDir)) {
            issues[indexDir] = [];
          }
          issues[indexDir].push({
            dir: comic.relativeDir,
            pages: metadata.pages
          });
          dir = indexDir;
          if (indexDir.length < 1) {
            break;
          }
        }
      }
      newchildren = {};
      for (indexDir in children) {
        indexlist = children[indexDir];
        list = [];
        keys = Object.keys(indexlist);
        for (j = 0, len1 = keys.length; j < len1; j++) {
          k = keys[j];
          list.push(indexlist[k]);
        }
        newchildren[indexDir] = list;
      }
      children = newchildren;
      serverManifest = {
        issues: issues,
        children: children,
        flat: flat,
        exists: exists
      };
      fs.writeFileSync(cfs.join(this.rootDir, constants.MANIFEST_SERVER_FILENAME), JSON.stringify(serverManifest, null, 2));
      clientManifest = {
        children: children,
        exists: exists
      };
      return fs.writeFileSync(cfs.join(this.rootDir, constants.MANIFEST_CLIENT_FILENAME), JSON.stringify(clientManifest, null, 2));
    };

    return ManifestGenerator;

  })();

  module.exports = ManifestGenerator;

}).call(this);
